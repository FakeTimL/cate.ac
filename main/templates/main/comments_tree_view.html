{% load i18n humanize %}
<!-- TODO: refactor using Vue -->

{% for comment in all_comments %}
{% with cid=comment.0.id u=comment.0.user %}
<div class="comment">
  <!-- Current comment -->
  <a class="ui circular avatar image" href="{% url 'accounts:profile' u.get_username %}">
    <img src="{{ u.profile.get_avatar }}" alt="{% blocktrans with username=u.get_username %}{{ username }}'s avatar{% endblocktrans %}" />
  </a>
  
  <div class="content">
    <a class="author" href="{% url 'accounts:profile' u.get_username %}"><span dir="auto">{{ u.get_username }}</span></a>
    <div class="metadata">
      <span class="date">{{ comment.0.publish_date|naturaltime }}</span>
    </div>
    <div class="markdown text">
      <p>{{ comment.0.text }}</p>
    </div>
    
    <!-- 'Reply Delete [Upvote] [Downvote] Full-screen' -->
    <div class="actions">
      {% if user.is_authenticated %}
      <a class="reply" href="#" onclick="toggleReplyBox('reply_form_{{ cid }}'); return false;">{% trans "Reply" %}</a>
      {% endif %}
      
      {% if u.id == user.id or user.is_staff %}
      <form style="display: none;" id="delete_form_{{ cid }}" action="{% url 'main:comment' cid %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="delete" value="1" />
        <input type="hidden" name="redirect_url" value="{{ redirect_url }}" />
      </form>
      <a href="#" onclick="if (window.confirm('{% trans " Are you sure to delete this comment and all its replies? " %}')) document.getElementById('delete_form_{{ cid }}').submit(); return false;">{% trans "Delete" %}</a>
      {% endif %}
      
      {% if u.id != user.id or user.is_staff %}
      <!--<a>{% trans "Upvote" %}</a>
      <a>{% trans "Downvote" %}</a>-->
      {% endif %}
      
      <a href="{% url 'main:comment' cid %}"><i class="expand icon"></i>{% trans "Full-screen" %}</a>
    </div>
    
    <!-- Reply box -->
    {% if user.is_authenticated %}
    <form style="display: none;" class="ui reply form" id="reply_form_{{ cid }}" action="{% url 'main:comment' cid %}" method="post">
      {% csrf_token %}
      <div class="field">
        <textarea style="resize: vertical;" placeholder="{% trans 'Say something...' %}" rows="8" name="content"></textarea>
      </div>
      <input type="hidden" name="redirect_url" value="{{ redirect_url }}" />
      <input class="ui button primary" type="submit" value="{% trans 'Reply' %}" />
      <a href="#" class="ui button" onclick="toggleReplyBox('reply_form_{{ cid }}'); return false;">{% trans 'Close' %}</a>
    </form>
    {% endif %}
  </div>
  
  <!-- Replies to the current comment -->
  {% if comment.1|length %}
  <div class="comments">
    {% include "main/comments_tree_view.html" with all_comments=comment.1 %}
  </div>
  {% elif comment.2 %}
  <div class="comments">
    <a href="{% url 'main:comment' cid %}">{% trans "See more..." %}</a>
  </div>
  {% endif %}
</div>
{% endwith %}
{% endfor %}
